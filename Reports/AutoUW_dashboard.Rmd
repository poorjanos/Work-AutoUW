---
title: "Automatikus kötvényesítés havi riport"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: spacelab
---

```{r setup, include=FALSE}
library(flexdashboard)
library(dplyr)
library(tidyr)
library(ggplot2)
library(lubridate)
library(scales)
library(stringr)
library(ggiraph)

# Import helper functions
source(here::here("R", "data_manipulation.R"), local = TRUE)
```


Bevezetõ {data-navmenu="Tartalom"}
===================================== 

Column {data-width=300}
-------------------------------------

### Mirõl szól ez a riport?

* A kötvényesítési folyamatban keletkezõ költségek csökkentésének egyik eszköze az automatikus kötvényesítés (központi menesztés). A riport célja, hogy rendszeres adatszolgáltatást nyújtson az automatizmus mûködésének kiértékeléséhez és segítse annak további optimalizációját.  
* A riport hónapról hónapra követi az automatikus kötvényesítés 
    + sikerességét,
    + a hibaokok és hibamintázatok összetételét, 
    + és azon költségek alakulását, melyet a sikertelen ágon szenved el vállalat manuális munkaerõ-szükséglet formájában.
* Használat: a fenti *Tartalom* gombra kattintva további lapok nyithatók mag

Column {data-width=700}
-------------------------------------

### Sikerarány és a hibaág manuális feldolgozásának FTE igénye 

```{r, fig.width = 8}
cost_monthly <- read.csv(here::here("Data", "p1_cost_monthly.csv"))

p <- ggplot(cost_monthly, aes(x = IDOSZAK, group = 1)) +
  geom_line(aes(y = SIKER_PER_TELJES, colour = "Sikerarány")) +
  geom_line(aes(y = FTE / 30, colour = "FTE igény")) +
  geom_point_interactive(aes(y = SIKER_PER_TELJES, colour = "Sikerarány", tooltip = paste0(round(SIKER_PER_TELJES*100, 2), "%"))) +
  geom_point_interactive(aes(y = FTE / 30, colour = "FTE igény", tooltip = paste(round(FTE, 2), "FTE"))) +
  scale_y_continuous(labels = percent, sec.axis = sec_axis(~ . * 30, name = "Sikertelen ág manuális FTE igénye [db]")) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(
    y = "Sikerarány a teljes feldlgozott állományban [%]",
    x = "Idõszak",
    colour = "Mutató"
  ) +
  theme(legend.position = c(0.8, 0.9))

ggiraph(code = print(p), width_svg = 8)
```



Sikerarány {.storyboard data-navmenu="Tartalom"}
=========================================

### Ezen az ábrán automatikus kötvényesítés sikerességét a **teljes állományon** értékeljük ki több mutató mentén 

```{r, fig.width=10}
auw_main <- read.csv(here::here("Data", "p2_auw_main.csv"))

plot_success(auw_main, use_facet = FALSE, fig_size = 10)
```

***
Az automatiks kötvényesítés teljesítményét három mutató alapján értékelhetjük:

- **KISERELT**: a kísérlet, próbálkozás aránya, azaz az állomány mekkora hányadán futtott az adott idõszakban automatikus menesztés
- **SIKER_PER_KISERELT**: sikerarány azon állományon, melyet az automatika megkísérelt elmeneszteni (magyarul, ahol futott központi menesztés)
- **SIKER_PER_TELJES**: sikerarány a teljes állományon, tehát azt a halmazt is számításba véve, ahol nem fut központi menesztés

### Ezen az ábrán automatikus kötvényesítés sikerességét **termékcsoportonként** értékeljük ki több mutató mentén

```{r, fig.width=12, fig.height=6}
auw_prod <- read.csv(here::here("Data", "p2_auw_prod.csv"))

plot_success(
  auw_prod,
  use_facet = TRUE,
  facet_two = "MODTYP",
  fig_size = 10,
  x_label_size = 6
)
```

***
Az automatiks kötvényesítés teljesítményét három mutató alapján értékelhetjük:

- **KISERELT**: a kísérlet, próbálkozás aránya, azaz az állomány mekkora hányadán futtott az adott idõszakban automatikus menesztés
- **SIKER_PER_KISERELT**: sikerarány azon állományon, melyet az automatika megkísérelt elmeneszteni (magyarul, ahol futott központi menesztés)
- **SIKER_PER_TELJES**: sikerarány a teljes állományon, tehát azt a halmazt is számításba véve, ahol nem fut központi menesztés

### Ezen az ábrán automatikus kötvényesítés sikerességét **termékcsoportonként** és **kötési módonként** értékeljük ki több mutató mentén

```{r, fig.width=12, fig.height=6}
auw_prod_media <-
  read.csv(here::here("Data", "p2_auw_prod_media.csv"))
  
plot_success(
  auw_prod_media,
  use_facet = TRUE,
  facet_one = "MODTYP",
  facet_two = "PAPIR_TIPUS",
  fig_size = 10,
  x_label_size = 4
)
```

***
Az automatiks kötvényesítés teljesítményét három mutató alapján értékelhetjük:

- **KISERELT**: a kísérlet, próbálkozás aránya, azaz az állomány mekkora hányadán futtott az adott idõszakban automatikus menesztés
- **SIKER_PER_KISERELT**: sikerarány azon állományon, melyet az automatika megkísérelt elmeneszteni (magyarul, ahol futott központi menesztés)
- **SIKER_PER_TELJES**: sikerarány a teljes állományon, tehát azt a halmazt is számításba véve, ahol nem fut központi menesztés

### Ezen az ábrán automatikus kötvényesítés sikerességét a **KGFB** termékcsoporton és annak **kötési okaiként** értékeljük ki több mutató mentén

```{r, fig.width=12, fig.height=6}
auw_tpml_ctype <-
  read.csv(here::here("Data", "p2_auw_tpml_ctype.csv"))
  
plot_success(
  auw_tpml_ctype,
  use_facet = TRUE,
  facet_two = "GFB_KOTES_NEV",
  fig_size = 10,
  x_label_size = 3
)
```

***
Az automatiks kötvényesítés teljesítményét három mutató alapján értékelhetjük:

- **KISERELT**: a kísérlet, próbálkozás aránya, azaz az állomány mekkora hányadán futtott az adott idõszakban automatikus menesztés
- **SIKER_PER_KISERELT**: sikerarány azon állományon, melyet az automatika megkísérelt elmeneszteni (magyarul, ahol futott központi menesztés)
- **SIKER_PER_TELJES**: sikerarány a teljes állományon, tehát azt a halmazt is számításba véve, ahol nem fut központi menesztés


### Ezen az ábrán automatikus kötvényesítés sikerességét hasonlítjuk össze az **LSZB** és **OKÉ** lakástermékeken

```{r, fig.width=12, fig.height=6}
home_prod_main <-
  read.csv(here::here("Data", "home_prod_main.csv"))
  
plot_success(
  home_prod_main,
  use_facet = TRUE,
  facet_two = "MODKOD",
  fig_size = 10,
  x_label_size = 3
)
```

***
Az automatiks kötvényesítés teljesítményét három mutató alapján értékelhetjük:

- **KISERELT**: a kísérlet, próbálkozás aránya, azaz az állomány mekkora hányadán futtott az adott idõszakban automatikus menesztés
- **SIKER_PER_KISERELT**: sikerarány azon állományon, melyet az automatika megkísérelt elmeneszteni (magyarul, ahol futott központi menesztés)
- **SIKER_PER_TELJES**: sikerarány a teljes állományon, tehát azt a halmazt is számításba véve, ahol nem fut központi menesztés


Hibaokok {.storyboard data-navmenu="Tartalom"}
=========================================

### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult hibaokok relatív gyakoriságát mutatjuk meg a **teljes állományon** 

```{r, fig.width=14, fig.height=6}
error_freq <- read.csv(here::here("Data", "p3_error_freq.csv"))

plot_error_freq(
  error_freq,
  use_facet = FALSE,
  fig_size = 10,
  x_label_size = 8,
  y_label_size = 12
)
```

***
* A hibaok relatív gyakorisága azt jelenti, hogy a vizsgált idõszakban (jelen esetben a legutolsó 3 hónapban) egy hibaok az összes hibaok mekkora hányadát tette ki, vagyis relatíve mennyire nagy a súlya
* A teljes állományon számolt arányokon túl termékcsoportonként jelentõsen eltérõ okokat figyelhetünk meg, ezért fontos a hibaokokat termékenként értelmezni (lásd. következõ dia)


### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult hibaokok relatív gyakoriságát mutatjuk meg **termékcsoportonként** 

```{r, fig.width=14, fig.height=6}
error_freq_prod <- read.csv(here::here("Data", "p3_error_freq_prod.csv"))

plot_error_freq(
  error_freq_prod,
  use_facet = TRUE,
  facet_two = "MODTYP",
  fig_size = 10,
  x_label_size = 8,
  y_label_size = 10
)
```

***
* A hibaok relatív gyakorisága a **termékcsopoton belül** azt jelenti, hogy a vizsgált idõszakban (jelen esetben a legutolsó 3 hónapban) egy hibaok a **termékcsoport esetében számolt** összes hibaok mekkora hányadát tette ki, vagyis relatíve mennyire nagy a termékcsoporton belüli súlya
* A teljes állományon számolt arányokon túl termékcsoportonként jelentõsen eltérõ okokat figyelhetünk meg, ezért fontos a hibaokokat termékenként értelmezni
* Megfigyelhetõ, hogy a termékcsoportokra más-más hibaokok jellemzõek, jóllehet néhány esetében közös elõforduás is tapasztalható


### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult hibaokok relatív gyakoriságát mutatjuk meg az **LSZB** és **OKÉ** lakástermékeken

```{r, fig.width=14, fig.height=6}
home_prod_error_freq <- read.csv(here::here("Data", "home_prod_error_freq.csv"))

plot_error_freq(
  home_prod_error_freq,
  use_facet = TRUE,
  facet_two = "MODKOD",
  fig_size = 10,
  x_label_size = 8,
  y_label_size = 10
)
```

***
* A hibaok relatív gyakorisága a **termékcsopoton belül** azt jelenti, hogy a vizsgált idõszakban (jelen esetben a legutolsó 3 hónapban) egy hibaok a **termékcsoport esetében számolt** összes hibaok mekkora hányadát tette ki, vagyis relatíve mennyire nagy a termékcsoporton belüli súlya
* A teljes állományon számolt arányokon túl termékcsoportonként jelentõsen eltérõ okokat figyelhetünk meg, ezért fontos a hibaokokat termékenként értelmezni
* Megfigyelhetõ, hogy a termékcsoportokra más-más hibaokok jellemzõek, jóllehet néhány esetében közös elõforduás is tapasztalható


### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult **hibaokok gyakoriságának idõbeli alakulását** mutatjuk meg **a KGFB termékcsoportban** 

```{r, fig.width=14, fig.height=8}
error_freq_prod_mc <- read.csv(here::here("Data", "p3_error_freq_prod_mc.csv"))

plot_error_freq_ts(
  error_freq_prod_mc,
  subset_by = "GFB",
  facet_by = "HIBA",
  fig_width = 14,
  fig_height = 8
)
```

***
* Egy adott hibaok gyakoriságának idõbeli alakulásából következtetni lehet olyan eseményekre, melyek befolyásolhatták egy adott hiba egyre gyakoribb, vagy egyre ritkább elõfordulását
* A pontos beavatkozási területek meghatározásához ugyanakkor nem elegendõ a hibaokok külön-külön vizsgálata, hanem az egymással együtt elõforduló *mintázatok* vizsgálata szükséges


### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult **hibaokok gyakoriságának idõbeli alakulását** mutatjuk meg **a Lakás termékcsoportban** 

```{r, fig.width=14, fig.height=8}
error_freq_prod_mc <- read.csv(here::here("Data", "p3_error_freq_prod_mc.csv"))

plot_error_freq_ts(
  error_freq_prod_mc,
  subset_by = "Lakás",
  facet_by = "HIBA",
  fig_width = 14,
  fig_height = 8
)
```

***
* Egy adott hibaok gyakoriságának idõbeli alakulásából következtetni lehet olyan eseményekre, melyek befolyásolhatták egy adott hiba egyre gyakoribb, vagy egyre ritkább elõfordulását
* A pontos beavatkozási területek meghatározásához ugyanakkor nem elegendõ a hibaokok külön-külön vizsgálata, hanem az egymással együtt elõforduló *mintázatok* vizsgálata szükséges



***
* Egy adott hibaok gyakoriságának idõbeli alakulásából következtetni lehet olyan eseményekre, melyek befolyásolhatták egy adott hiba egyre gyakoribb, vagy egyre ritkább elõfordulását
* A pontos beavatkozási területek meghatározásához ugyanakkor nem elegendõ a hibaokok külön-külön vizsgálata, hanem az egymással együtt elõforduló *mintázatok* vizsgálata szükséges

Hibamintázatok {.storyboard data-navmenu="Tartalom"}
=========================================

### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult hibamintázatok relatív gyakoriságát mutatjuk meg a **teljes állományon** 

```{r, fig.width=14, fig.height=6}
error_freq_pattern <- read.csv(here::here("Data", "p4_error_freq_pattern.csv"))

plot_error_pattern_freq(
  error_freq_pattern,
  use_facet = FALSE,
  fig_width = 14,
  fig_height = 6,
  x_label_size = 8,
  y_label_size = 10
)
```

***
* A hibamintázat együttesen elõforduló hibaokok láncolatát jelenti
* A hibamintázat pontosabb képet ad arról, hogy az automatikus menesztés miért vallott kudarcot
* Az egy mintázaton belüli különbözõ hibaokokat három csillag (***) választja el egymástól
* Vannak mintázatok, melyek mindössze egyetlen okból állnak
* A hibamintázat relatív gyakorisága azt jelenti, hogy a vizsgált idõszakban (jelen esetben a legutolsó 3 hónapban) egy mintázat az összes mintázat mekkora hányadát tette ki, vagyis relatíve mennyire nagy a súlya
* A teljes állományon számolt arányokon túl termékcsoportonként jelentõsen eltérõ mintázatokat figyelhetünk meg, ezért fontos a mintázatokat termékenként értelmezni (lásd. következõ dia)


### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult hibamintázatok relatív gyakoriságát mutatjuk meg **termékcsoportonként** 

```{r, fig.width=14, fig.height=6}
error_freq_pattern_prod <- read.csv(here::here("Data", "p4_error_freq_pattern_prod.csv"))

plot_error_pattern_freq(
  error_freq_pattern_prod,
  use_facet = TRUE,
  facet_two = "MODTYP",
  fig_width = 14,
  fig_height = 6,
  x_label_size = 8,
  y_label_size = 10
)
```

***
* A hibamintázat együttesen elõforduló hibaokok láncolatát jelenti
* A hibamintázat pontosabb képet ad arról, hogy az automatikus menesztés miért vallott kudarcot
* Vannak mintázatok, melyek mindössze egyetlen okból állnak
* A hibamintázat relatív gyakorisága a termékcsoporton belülazt jelenti, hogy a vizsgált idõszakban (jelen esetben a legutolsó 3 hónapban) egy mintázat a termékcsport esetében megfigyelt összes mintázat mekkora hányadát tette ki, vagyis relatíve mennyire nagy a  termékcsoporton belüli súlya
* A teljes állományon számolt arányokon túl termékcsoportonként jelentõsen eltérõ mintázatokat figyelhetünk meg, ezért fontos a mintázatokat termékenként értelmezni


### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult hibamintázatok relatív gyakoriságát mutatjuk meg az **LSZB** és **OKÉ** lakástermékeken 

```{r, fig.width=14, fig.height=6}
home_freq_pattern_prod <- read.csv(here::here("Data", "home_prod_freq_pattern.csv"))

plot_error_pattern_freq(
  home_freq_pattern_prod,
  use_facet = TRUE,
  facet_two = "MODKOD",
  fig_width = 14,
  fig_height = 6,
  x_label_size = 8,
  y_label_size = 10
)
```

***
* A hibamintázat együttesen elõforduló hibaokok láncolatát jelenti
* A hibamintázat pontosabb képet ad arról, hogy az automatikus menesztés miért vallott kudarcot
* Vannak mintázatok, melyek mindössze egyetlen okból állnak
* A hibamintázat relatív gyakorisága a termékcsoporton belülazt jelenti, hogy a vizsgált idõszakban (jelen esetben a legutolsó 3 hónapban) egy mintázat a termékcsport esetében megfigyelt összes mintázat mekkora hányadát tette ki, vagyis relatíve mennyire nagy a  termékcsoporton belüli súlya
* A teljes állományon számolt arányokon túl termékcsoportonként jelentõsen eltérõ mintázatokat figyelhetünk meg, ezért fontos a mintázatokat termékenként értelmezni


### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult **hibamintázat gyakoriságának idõbeli alakulását** mutatjuk meg **a KGFB termékcsoportban** 

```{r, fig.width=14, fig.height=8}
error_freq_pattern_prod_mc <- read.csv(here::here("Data", "p4_error_freq_pattern_prod_mc.csv"))

plot_error_freq_ts(
  error_freq_pattern_prod_mc,
  subset_by = "GFB",
  facet_by = "HIBA_MINTA",
  fig_width = 14,
  fig_height = 8
)
```

***
* Egy adott hibamintázat gyakoriságának idõbeli alakulásából következtetni lehet olyan eseményekre, melyek befolyásolhatták egy adott hibák egyre gyakoribb, vagy egyre ritkább elõfordulását


### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult **hibaokok gyakoriságának idõbeli alakulását** mutatjuk meg **a Lakás termékcsoportban** 

```{r, fig.width=14, fig.height=8}
error_freq_pattern_prod_mc <- read.csv(here::here("Data", "p4_error_freq_pattern_prod_mc.csv"))

plot_error_freq_ts(
  error_freq_pattern_prod_mc,
  subset_by = "Lakás",
  facet_by = "HIBA_MINTA",
  fig_width = 14,
  fig_height = 8
)
```

***
* Egy adott hibamintázat gyakoriságának idõbeli alakulásából következtetni lehet olyan eseményekre, melyek befolyásolhatták egy adott hibák egyre gyakoribb, vagy egyre ritkább elõfordulását



Költségek {.storyboard data-navmenu="Tartalom"}
=========================================

### Ezen az ábrán az automatikus kötvényesítés hibaágának manuális utókezelésének költségeit mutatjuk meg **termékcsoportonként** idõben

```{r, fig.width=12}
cost_prod_monthly <- read.csv(here::here("Data", "p5_cost_prod_monthly.csv"))

p <- ggplot(cost_prod_monthly, aes(x = IDOSZAK, group = 1)) +
  geom_line(aes(y = SIKER_PER_TELJES, colour = 'Sikerarány')) +
  geom_line(aes(y = FTE/20, colour = "FTE igény")) +
  geom_point_interactive(aes(y = SIKER_PER_TELJES, colour = 'Sikerarány', tooltip = paste0(round(SIKER_PER_TELJES*100, 2), "%"))) +
  geom_point_interactive(aes(y = FTE/20, colour = "FTE igény", tooltip = paste(round(FTE, 2), "FTE"))) +
  scale_y_continuous(labels = percent, sec.axis = sec_axis(~.*20, name = "FTE [db]")) +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(y = "Sikerarány [%]",
       x = "Idõszak",
       colour = "Mutató") +
  theme(legend.position = c(0.95, 0.95)) +
  coord_cartesian(ylim = c(0.0, 0.7)) +
  facet_grid(.~MODTYP)

ggiraph(code = print(p), width_svg = 12)
```

***
* Az automatikus kötvényesítés hibára futása esetén az ajánlatot manuálisan kell feldolgozni
* A workflow rendszer (Kontakt) minden manuális tevékenységet tárol, így ponosan kiszámolható a hibaág kezelésének FTE igénye
* Az FTE igény nem egyenlõ a létszámigénnyel, mivel az FTE a tiszta munkaidõigényt mutatja és nem számol a betegségek és szabadságok hatásával
* A létszámigény meghatározásához az FTE igény 1.3-al kell szorozni (iparági sztenderd)
* A sikerarány és a manuális munka FTE költség negatív korrelációja jól látható az ábrán: ha a sikerarány csökken, az FTE igény nõ


### Ezen az ábrán az elmúlt 3 hónapban legtöbbször elõfordult hibamintázatok havi FTE igényét mutatjuk meg **termékcsoportonként**

```{r, fig.width=14, fig.height=6}
cost_pattern_last3 <- read.csv(here::here("Data", "p5_cost_pattern_last3.csv"))

p <- ggplot(cost_pattern_last3, aes(
  x = factor(cost_pattern_last3$HIBA_MINTA, levels = unique(cost_pattern_last3$HIBA_MINTA[order(cost_pattern_last3$FTE)])),
  y = FTE
)) +
  geom_bar_interactive(stat = "identity", aes(tooltip = paste(round(FTE, 2), "FTE"))) +
  #geom_bar(stat = "identity") +
    theme(axis.text.y = element_text(size = 10)) +
  scale_x_discrete(
    labels = function(x)
      str_wrap(x, width = 180)
  ) +
  coord_flip() +
  labs(y = "Havi FTE igény",
       x = "Hiba mintázat") +
  facet_grid(. ~ MODTYP)
  
ggiraph(code = print(p), width_svg = 14, height_svg = 6)
```

***
* A termékcsoportonkénti hiba mintázatok FTE igénye megmutatja a vállalat számára legköltségesebb hibadimenziókat és segít a további optimalizáció irányának kijelölésében